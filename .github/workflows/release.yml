name: Release

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build & Release
    runs-on: macos-14

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.4'

      - name: Cache Homebrew packages
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/Homebrew
            /opt/homebrew/Cellar
          key: ${{ runner.os }}-homebrew-${{ hashFiles('.github/workflows/release.yml') }}
          restore-keys: |
            ${{ runner.os }}-homebrew-

      - name: Cache Swift build
        uses: actions/cache@v4
        with:
          path: src/app/.build
          key: ${{ runner.os }}-swift-release-${{ hashFiles('src/app/Package.swift', 'src/app/AmirrorApp.swift') }}
          restore-keys: |
            ${{ runner.os }}-swift-release-

      - name: Install dependencies
        run: brew install coreutils

      - name: Make scripts executable
        run: |
          chmod +x amirror
          chmod +x src/cli/amirror
          chmod +x src/cli/amirror.sh
          chmod +x src/cli/doctor.sh
          chmod +x src/app/build.sh
          chmod +x test/test-runner.sh

      - name: Generate version
        id: version
        run: |
          VERSION="1.0.$(date +%Y%m%d)-$(git rev-parse --short HEAD)"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Version: $VERSION"

      - name: Build Swift app
        working-directory: src/app
        run: |
          echo "ðŸ”¨ Building Amirror..."
          swift build -c release
          echo "âœ… Build successful!"

      - name: Create app bundle
        working-directory: src/app
        run: |
          RELEASE_DIR=".build/arm64-apple-macosx/release"
          APP_BUNDLE="Amirror.app"
          
          rm -rf "${APP_BUNDLE}"
          mkdir -p "${APP_BUNDLE}/Contents/MacOS"
          mkdir -p "${APP_BUNDLE}/Contents/Resources"
          
          cp "${RELEASE_DIR}/Amirror" "${APP_BUNDLE}/Contents/MacOS/"
          chmod +x "${APP_BUNDLE}/Contents/MacOS/Amirror"
          cp "Info.plist" "${APP_BUNDLE}/Contents/"
          echo "APPL????" > "${APP_BUNDLE}/Contents/PkgInfo"
          
          echo "âœ… App bundle created!"

      - name: Run tests
        run: |
          echo "ðŸ§ª Running test suite..."
          ./test/test-runner.sh

      - name: Create ZIP archive
        working-directory: src/app
        run: |
          VERSION=${{ steps.version.outputs.version }}
          zip -r "Amirror-${VERSION}-macos.zip" Amirror.app
          echo "ðŸ“¦ Created Amirror-${VERSION}-macos.zip"

      - name: Create DMG
        working-directory: src/app
        run: |
          VERSION=${{ steps.version.outputs.version }}
          DMG_DIR="dmg_temp"
          mkdir -p "${DMG_DIR}"
          cp -r Amirror.app "${DMG_DIR}/"
          ln -s /Applications "${DMG_DIR}/Applications"
          hdiutil create -volname "Amirror ${VERSION}" \
            -srcfolder "${DMG_DIR}" \
            -ov -format UDZO \
            "Amirror-${VERSION}-macos.dmg"
          rm -rf "${DMG_DIR}"
          echo "ðŸ’¿ Created Amirror-${VERSION}-macos.dmg"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Amirror v${{ steps.version.outputs.version }}
          body: |
            ## Amirror v${{ steps.version.outputs.version }}
            
            ðŸªž Professional Android screen mirroring for macOS.
            
            ### Installation
            
            **Option 1: DMG (Recommended)**
            1. Download `Amirror-${{ steps.version.outputs.version }}-macos.dmg`
            2. Open the DMG file
            3. Drag Amirror to Applications folder
            4. Open from Applications
            
            **Option 2: ZIP**
            1. Download `Amirror-${{ steps.version.outputs.version }}-macos.zip`
            2. Extract and move `Amirror.app` to Applications
            
            ### Requirements
            - macOS 13.0 (Ventura) or later
            - Install dependencies: `brew install scrcpy coreutils`
            
            ### CLI Usage
            ```bash
            ./amirror doctor   # Check system
            ./amirror start    # Start mirroring
            ./amirror list     # List devices
            ```
          draft: false
          prerelease: false
          files: |
            src/app/Amirror-${{ steps.version.outputs.version }}-macos.zip
            src/app/Amirror-${{ steps.version.outputs.version }}-macos.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
