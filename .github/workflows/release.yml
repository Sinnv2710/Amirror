name: Build

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  build:
    name: Build & Test
    runs-on: macos-14

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.4'

      - name: Cache Homebrew packages
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/Homebrew
            /opt/homebrew/Cellar
          key: ${{ runner.os }}-homebrew-${{ hashFiles('.github/workflows/release.yml') }}
          restore-keys: |
            ${{ runner.os }}-homebrew-

      - name: Cache Swift build
        uses: actions/cache@v4
        with:
          path: src/app/.build
          key: ${{ runner.os }}-swift-${{ hashFiles('src/app/Package.swift', 'src/app/AmirrorApp.swift') }}
          restore-keys: |
            ${{ runner.os }}-swift-

      - name: Install dependencies
        run: brew install coreutils

      - name: Make scripts executable
        run: |
          chmod +x amirror
          chmod +x src/cli/amirror
          chmod +x src/cli/amirror.sh
          chmod +x src/cli/doctor.sh
          chmod +x src/app/build.sh
          chmod +x test/test-runner.sh

      - name: Build Swift app
        working-directory: src/app
        run: |
          echo "ðŸ”¨ Building Amirror..."
          swift build -c release
          echo "âœ… Build successful!"

      - name: Create app bundle
        working-directory: src/app
        run: |
          RELEASE_DIR=".build/arm64-apple-macosx/release"
          APP_BUNDLE="Amirror.app"
          
          rm -rf "${APP_BUNDLE}"
          mkdir -p "${APP_BUNDLE}/Contents/MacOS"
          mkdir -p "${APP_BUNDLE}/Contents/Resources"
          
          cp "${RELEASE_DIR}/Amirror" "${APP_BUNDLE}/Contents/MacOS/"
          chmod +x "${APP_BUNDLE}/Contents/MacOS/Amirror"
          cp "Info.plist" "${APP_BUNDLE}/Contents/"
          echo "APPL????" > "${APP_BUNDLE}/Contents/PkgInfo"
          
          echo "âœ… App bundle created!"

      - name: Run tests
        run: |
          echo "ðŸ§ª Running test suite..."
          ./test/test-runner.sh

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: Amirror-${{ github.sha }}
          path: src/app/Amirror.app
          retention-days: 30
